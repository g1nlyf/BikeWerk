================================================================================
EUBIKE: THE AUTONOMOUS DIGITAL EMPIRE — ПОЛНАЯ ТЕХНИЧЕСКАЯ И ЛОГИЧЕСКАЯ ДОКУМЕНТАЦИЯ
================================================================================
ВЕРСИЯ ДОКУМЕНТА: 1.1
ДАТА: 2026-01-20
АВТОР: AUTONOMOUS CTO (TRAE AI)

ОГЛАВЛЕНИЕ:
1. КОНЦЕПЦИЯ И ФИЛОСОФИЯ
2. ТЕХНОЛОГИЧЕСКИЙ СТЕК
3. АРХИТЕКТУРА СИСТЕМЫ (HIGH-LEVEL)
4. ЯДРО: AUTOHUNTER (МЕХАНИКА ОХОТЫ)
5. БИЗНЕС-ЛОГИКА И ЭКОНОМИКА (ARBITRAGE ENGINE)
6. FRONTEND: ВИЗУАЛ И ДИЗАЙН-КОДЫ (EUPHORIA UX)
7. ЛОГИСТИЧЕСКАЯ ТРИАДА
8. ИНФРАСТРУКТУРА И ДЕПЛОЙМЕНТ
9. АДМИНИСТРИРОВАНИЕ И TELEGRAM-БОТ
10. DEEP DIVE (FAQ)

================================================================================
1. КОНЦЕПЦИЯ И ФИЛОСОФИЯ
================================================================================
EUBike — это не просто интернет-магазин, а автономная система цифрового арбитража премиальных велосипедов. 
Суть бизнеса: автоматический поиск недооцененных лотов (велосипедов) на европейских площадках (Kleinanzeigen, Buycycle), их анализ, выкуп, логистика и перепродажа с высокой маржой.

Ключевые принципы:
- **Zero Silence Policy:** Система всегда сообщает о своих действиях.
- **Test-Driven Autonomy:** Каждое действие верифицируется тестами.
- **Эстетика "Эйфория":** Интерфейс должен вызывать эмоциональный отклик (Apple-like quality).

================================================================================
2. ТЕХНОЛОГИЧЕСКИЙ СТЕК
================================================================================
Система построена на современном стеке JS/TS:

FRONTEND:
- **Framework:** React 18 (Vite)
- **Styling:** Tailwind CSS + Framer Motion (анимации)
- **State Management:** React Context + Hooks
- **Routing:** React Router DOM

BACKEND:
- **Runtime:** Node.js
- **Server:** Express.js
- **Database:** SQLite (локально/прод) + Supabase (архив/CRM)
- **ORM/Query:** Прямые SQL-запросы (better control) + Knex (частично)

AI & AUTOMATION:
- **LLM:** Google Gemini 2.5 Flash (Vision + Text) — основной "рабочий конь".
- **Browser Automation:** Puppeteer (с плагинами stealth) для эмуляции поведения человека.
- **Proxy:** Ротируемые прокси (Webshare/Mobile) для обхода блокировок.

INFRASTRUCTURE:
- **Server OS:** Windows Server (текущая среда разработки/тестов) / Linux (target)
- **Process Manager:** PM2 (управление процессами server, bot, scheduler)
- **Deployment:** Custom scripts (auto_deploy.js, deploy.ps1)

================================================================================
3. АРХИТЕКТУРА СИСТЕМЫ (HIGH-LEVEL)
================================================================================
Система состоит из трех основных модулей, связанных единой базой данных:

[HUNTER BOT] <---> [DATABASE (SQLite)] <---> [BACKEND API] <---> [FRONTEND UI]
      ^                                           ^
      |                                           |
[TELEGRAM ADMIN] ----------------------------------

1. **Hunter Bot:** Автономный скрипт, сканирующий интернет.
2. **Backend API:** Раздает данные фронтенду, управляет заказами, курсами валют.
3. **Frontend:** Витрина для покупателя.
4. **Telegram Bot:** Пульт управления для менеджеров (валидация лотов, уведомления).

================================================================================
4. ЯДРО: AUTOHUNTER (МЕХАНИКА ОХОТЫ)
================================================================================
Самая сложная и важная часть системы.

4.1. ПАЙПЛАЙН ОХОТЫ (THE HUNT LOOP)
-----------------------------------
Процесс поиска велосипеда проходит следующие этапы:

1. **Targeting (UnifiedHunter.js):**
   - Генерируются поисковые ссылки (Templates) на основе категорий (MTB, Road, Gravel).
   - Используются ценовые сегменты (A: 500-1000€, B: 1000-2500€, C: 2500€+).
   - Вращение брендов из `BrandConstants.js` (116+ комбинаций Бренд/Категория) для избежания перекосов.

2. **Parsing (Puppeteer):**
   - Бот заходит на Kleinanzeigen.de.
   - Обходит анти-бот защиту (скролл, задержки, user-agent).
   - Собирает сырые данные: заголовок, цена, описание, фото.

3. **Filtering (KillSwitchFilter.js):**
   - **Stop-words:** "суче", "defekt", "rahmen", "motorrad", "roller".
   - **Image Check:** Отсев объявлений с 1 фото или стоковыми картинками.
   - **Seller Check:** Отсев подозрительных профилей (дата регистрации, рейтинг).

4. **AI Analysis (TechDecoder + Gemini 2.5 Flash):**
   - **Vision:** Gemini анализирует фото (2 скриншота), определяет тип рамы, состояние, компоненты.
   - **Specs Extraction:** Извлекает год, размер рамы, группу оборудования (Shimano/SRAM).
   - **Scoring:** Присваивает "Hotness Score" (0-1000+) на основе ликвидности.

5. **Ingestion (Сохранение):**
   - Запись в БД со статусом `is_active=0` (требует модерации) или `1` (авто-публикация, если Score > 90).
   - Загрузка изображений локально (WebP конвертация).

4.2. МЕХАНИЗМЫ ЗАЩИТЫ
---------------------
- **DiversityManager:** Следит за распределением категорий (45% MTB, 25% Gravel, 20% Road, 8% eMTB, 2% Kids).
- **Duplicate Prevention:** Хеширование URL и заголовков для исключения повторов.
- **Arbiter Pattern:** Сравнение жестких данных парсера (RegEx) с галлюцинациями AI.

================================================================================
5. БИЗНЕС-ЛОГИКА И ЭКОНОМИКА (ARBITRAGE ENGINE)
================================================================================
5.1. ЦЕНООБРАЗОВАНИЕ (FINANCIAL AGENT)
--------------------------------------
Цена для клиента формируется динамически:
`Final Price = (Base Price € * Exchange Rate) + Logistics + Margin + Buffer`

- **Exchange Rate:** Парсится с OTP Bank (продажа наличных) или используется фоллбек (1.0436 * ЦБ).
- **Logistics:** Фиксированная стоимость доставки (зависит от региона).
- **Margin:** Динамическая наценка (обычно 20-30%, зависит от сегмента).

5.2. СТАТУСНАЯ МОДЕЛЬ ЗАКАЗА
----------------------------
Жизненный цикл заказа в CRM:
1. `new` (Новый)
2. `awaiting_deposit` (Ждем предоплату)
3. `deposit_paid` (Предоплата получена)
4. `inspection` (Проверка байка механиком)
5. `shipping` (В пути)
6. `ready_for_pickup` (На складе/ПВЗ)
7. `completed` (Выдан)

================================================================================
6. FRONTEND: ВИЗУАЛ И ДИЗАЙН-КОДЫ (EUPHORIA UX)
================================================================================
Дизайн-система "Эйфория" направлена на создание премиального ощущения.

6.1. ДИЗАЙН-КОДЫ И ГЕОМЕТРИЯ
----------------------------
- **Carousel:** Смещение -15% для создания эффекта бесконечной ленты.
- **Catalog Grid:** +15% отступы для "воздуха".
- **Peek Effect:** 20% видимости следующего слайда, побуждающее к свайпу.
- **Шрифты:** Inter / SF Pro Display (системный стек).
- **Цвета:**
  - Primary: #000000 (Onyx Black)
  - Accent: #FFD700 (Gold) - для High Profit зон.
  - Success: #10B981 (Emerald)
  - Surface: #F3F4F6 (Cool Gray)

6.2. КЛЮЧЕВЫЕ КОМПОНЕНТЫ
------------------------
- **BikeCard:** Карточка товара с "умными" бейджами (Logistics, Condition).
- **ProductDetailPage:** Страница товара с 21-пунктным чек-листом проверки.
- **High Profit Glow:** CSS `box-shadow` с золотым свечением для маржинальных лотов.

================================================================================
7. ЛОГИСТИЧЕСКАЯ ТРИАДА
================================================================================
Уникальная система классификации доставки для снижения тревожности клиента:

1. **Shipping Available (Green):** Стандартная доставка. Продавец готов отправить.
2. **Guaranteed Pickup (Blue):** "Только самовывоз", но лот в радиусе 100км от хаба (Марбург). Мы заберем сами.
3. **Local Lot (Orange):** "Только самовывоз", >100км. Мы договариваемся с продавцом (платим за коробку + бонус), чтобы он отправил.

================================================================================
8. ИНФРАСТРУКТУРА И ДЕПЛОЙМЕНТ
================================================================================
- **Скрипт `deploy.ps1`:** Единая точка входа.
  1. Бэкап БД.
  2. Синхронизация кода (rsync/git).
  3. Установка зависимостей (npm install).
  4. Перезапуск процессов (pm2 reload all).
  5. Прогон миграций БД.
  
- **PM2 Ecosystem:**
  - `server`: API Backend.
  - `telegram-bot`: Управляющий бот.
  - `hunter-scheduler` (AutonomousOrchestrator): Планировщик задач.

================================================================================
9. АДМИНИСТРИРОВАНИЕ И TELEGRAM-БОТ
================================================================================
Telegram-бот — это "пульт управления" Империей.
- **Доступ:** Строго ограничен списком `ADMIN_IDS` (3 авторизованных пользователя).
- **Функции:**
  - `/status`: Состояние серверов и хантера.
  - `/approve [id]`: Публикация лота в каталог.
  - `/reject [id]`: Удаление лота.
  - `/order [code]`: Работа с CRM заказами.
- **Manager UX:** Кнопки меняются в зависимости от статуса заказа (Status-Driven UI), предотвращая ошибки персонала.
- **Фото-отчеты:** Прямая загрузка фото инспекции через бот в Supabase Storage.

================================================================================
10. DEEP DIVE (FAQ)
================================================================================
**Q: Как часто запускается Hunter?**
A: Hunter работает в цикле через `AutonomousOrchestrator`. Планировщик запускает задачи круглосуточно с интервалами, нацеленными на обработку ~100 лотов в сутки (распределенных по категориям).

**Q: Сколько лотов попадает в каталог?**
A: Из 100 обработанных лотов в каталог попадает ~10-15% (High Quality), остальные отсеиваются фильтрами (KillSwitch, TechDecoder) или сохраняются в "Озеро данных" (Data Lake) для аналитики.

**Q: Какие модели AI используются?**
A: 
- **Gemini 2.5 Flash:** Основная модель для массовой обработки (парсинг, первичное скоринг, Vision). Быстрая и дешевая.
- **Gemini 3 Pro (Preview):** Резерв для сложных случаев глубокой дедукции (в планах для финальной проверки перед выкупом).

**Q: Как считается Hotness Score?**
A: Формула: `Score = (FMV - Price) * Views_Velocity`. 
Где `Views_Velocity = Views / Hours_Alive`. Чем выше прибыль и чем быстрее растет интерес к лоту, тем выше скор.

**Q: Что такое FMV и сколько нужно данных?**
A: Fair Market Value — справедливая рыночная цена. Рассчитывается как медиана по истории продаж (таблица `market_history`). Требуется минимум 3 записи (лучше 50) по конкретной модели для уверенного расчета.

**Q: Есть ли AI-парсер скриншотов переписки?**
A: В текущей версии (`bot.js`) реализована загрузка фото инспекции, но автоматический OCR и семантический анализ чатов с продавцами находится в разработке (Roadmap Feature).

================================================================================
КОНЕЦ ДОКУМЕНТАЦИИ
================================================================================
